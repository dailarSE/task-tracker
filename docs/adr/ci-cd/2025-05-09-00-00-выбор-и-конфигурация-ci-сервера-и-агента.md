# ADR-0009: Выбор и конфигурация CI-сервера и агента для сборки и тестирования

**Статус:** Accepted

**Дата:** 2025-05-09

## 1. Контекст

Для проекта "Task Tracker" необходима система непрерывной интеграции (CI) для автоматической сборки, тестирования и потенциально развертывания приложения при каждом изменении в коде. CI-система должна поддерживать сборку Maven-проектов, выполнение тестов (включая интеграционные тесты с Testcontainers, требующие Docker) и возможность расширения для будущих CD-задач. Доступна VPS с Ubuntu 22, где уже установлен Docker.

## 2. Принятое Решение

1.  **CI-сервер:** Использовать **Jenkins**, развернутый в Docker-контейнере на основной VPS. Образ `jenkins/jenkins:lts-jdk21` (или аналогичный с нужной версией JDK).
2.  **Jenkins Агент:** Использовать **внешний Jenkins агент**, установленный и работающий непосредственно на **хост-машине VPS Ubuntu 22**.
    *   **Подключение к Master:** Агент подключается к Jenkins Master (в Docker) через JNLP (или WebSocket).
    *   **Метка Агента:** Агенту присвоена метка (label) `ubuntu-docker` для использования в `Jenkinsfile`.
    *   **Доступ к Docker:** Пользователь, от имени которого работает агент на VPS, добавлен в группу `docker`, что обеспечивает агенту прямой доступ к Docker-демону хост-машины. Это необходимо для запуска Testcontainers.
    *   **Управление:** Агент настроен как systemd сервис для автоматического запуска при старте VPS.
3.  **`Jenkinsfile`:** Пайплайн Jenkins определяется в `Jenkinsfile` в корне репозитория, используется декларативный синтаксис.
4.  **Профиль для CI:** В приложении Spring Boot используется профиль `ci` (`application-ci.yml`) для специфичных настроек во время выполнения на CI-агенте (например, уровни логирования, отключение OTel SDK).

## 3. Рассмотренные Альтернативы

1.  **Использование `build-in-agent` Jenkins Master с доступом к Docker socket:**
    *   **Описание:** Монтирование Docker socket хоста (`/var/run/docker.sock`) внутрь контейнера Jenkins Master и выполнение всех сборок на встроенном агенте.
    *   **Плюсы:** Проще первоначальная настройка (один контейнер).
    *   **Минусы:**
        *   Проблемы с правами доступа к Docker socket изнутри контейнера от пользователя `jenkins` (требовали запуска от `root` или сложных манипуляций с группами, что менее безопасно для Master).
        *   Отсутствие Docker CLI внутри стандартного образа Jenkins Master, что требовало бы создания кастомного образа.
        *   Меньшая изоляция Jenkins Master от сборочных процессов.
    *   **Причина отклонения:** Сложности с правами и необходимостью кастомизации образа Jenkins Master. Внешний агент на хосте решает эти проблемы более чисто.

2.  **GitHub Actions (или GitLab CI, или другие SaaS CI/CD):**
    *   **Описание:** Использование облачных CI/CD платформ.
    *   **Плюсы:** Меньше инфраструктурных забот, хорошая интеграция с Git-хостингом, часто предоставляют готовые среды с Docker.
    *   **Минусы:** Для бюджетного проекта с фокусом на самостоятельной настройке инфраструктуры (включая Jenkins на VPS) этот вариант не соответствовал целям. Возможны ограничения бесплатных планов.
    *   **Причина отклонения:** Выбор был сделан в пользу самостоятельного развертывания Jenkins для более глубокого понимания CI/CD процессов и инфраструктуры.

3.  **Docker-in-Docker (DinD) для Jenkins Агента:**
    *   **Описание:** Запуск Jenkins агента в Docker-контейнере, который сам может запускать другие Docker-контейнеры.
    *   **Плюсы:** Изоляция сборочной среды.
    *   **Минусы:** Сложнее в настройке, может иметь проблемы с производительностью и безопасностью. Для нашего случая (когда хост и так VPS с Docker) это избыточно.
    *   **Причина отклонения:** Внешний агент на хосте проще и эффективнее для доступа к уже существующему Docker-демону.

## 4. Последствия

*   **Положительные:**
    *   Надежный запуск Testcontainers в CI, так как агент имеет прямой доступ к Docker на хосте.
    *   Jenkins Master остается более "чистым" и изолированным.
    *   Четкое разделение ролей: Master координирует, Agent выполняет.
    *   Агент как systemd сервис обеспечивает его автоматический запуск.
*   **Отрицательные/Затраты:**
    *   Необходимо установить и настроить Jenkins агент на VPS (Java, пользователь, права, systemd сервис).
    *   Необходимо поддерживать этого агента (обновления Java и т.д.).
    *   Если VPS имеет ограниченные ресурсы, одновременный запуск нескольких сборок на агенте может привести к их замедлению.
*   **Необходимые действия:**
    *   Настройка Jenkins Master для приема JNLP-агентов.
    *   Установка и настройка агента на VPS.
    *   Обновление `Jenkinsfile` для использования метки нового агента.
# ADR-0016: Конвенции и инструменты для интеграционного тестирования JPA и CI-отчетности

**Статус:** Accepted 
**Дата:** 2025-05-10 

## 1. Контекст

В рамках задачи CI-3 по настройке стадий тестирования и отчетности в CI, были выработаны и применены специфические подходы и конвенции для интеграционного тестирования слоя взаимодействия с базой данных (JPA) и для сбора/отображения результатов тестов и покрытия кода. Эти подходы дополняют общую стратегию тестирования, изложенную в ADR-0015.

## 2. Принятое Решение

1.  **Именование интеграционных тестов:**
    *   Интеграционные тесты, предназначенные для выполнения Maven Failsafe Plugin, должны именоваться с использованием суффикса `IT`. Например: `UserRepositoryIT.java`. Это соответствует стандартным паттернам Failsafe и упрощает конфигурацию.

2.  **Тестирование слоя JPA (Репозитории):**
    *   Для интеграционных тестов компонентов слоя JPA (например, Spring Data JPA репозиториев) рекомендуется использовать аннотацию `@DataJpaTest`.
    *   Эта аннотация загружает сфокусированный срез контекста Spring, необходимый для JPA, автоматически настраивает транзакционность для тестовых методов (с откатом по умолчанию) и может использоваться совместно с Testcontainers (через `@ServiceConnection`) для тестирования на реальной СУБД.

3.  **Отчетность по результатам тестов в CI (Jenkins):**
    *   Jenkins пайплайн настроен на сбор и публикацию результатов юнит-тестов (выполняемых Surefire) и интеграционных тестов (выполняемых Failsafe).
    *   Для этого используется стандартный шаг `junit` в `Jenkinsfile`, который обрабатывает XML-отчеты, генерируемые Maven-плагинами.

4.  **Отчетность по покрытию кода в CI (Jenkins):**
    *   Для сбора данных о покрытии кода используется JaCoCo Maven Plugin, настроенный на сбор данных как от юнит-, так и от интеграционных тестов в единый файл `jacoco.exec`.
    *   Для публикации и визуализации отчетов о покрытии в Jenkins используется "coverage plugin" через шаг `recordCoverage` в `Jenkinsfile`. Пайплайн настроен на обработку XML-отчета `jacoco.xml`.

## 3. Рассмотренные Альтернативы

1.  **Именование интеграционных тестов:**
    *   Использование суффикса `*IntegrationTest.java` с кастомной конфигурацией Failsafe `includes`.
        *   *Причина отклонения:* Использование стандартного суффикса `*IT.java` проще и требует меньше конфигурации.
2.  **Тестирование JPA-слоя:**
    *   Использование аннотации `@SpringBootTest` для всех интеграционных тестов JPA.
        *   *Причина отклонения:* `@DataJpaTest` более легковесен, загружает только необходимый контекст, что ускоряет тесты и лучше изолирует слой данных.

## 4. Последствия

*   **Положительные:**
    *   Стандартизация именования интеграционных тестов упрощает их идентификацию и конфигурацию сборки.
    *   Использование `@DataJpaTest` повышает эффективность и скорость тестирования JPA-компонентов.
    *   Автоматическая публикация результатов тестов и отчетов о покрытии в CI обеспечивает прозрачность и помогает отслеживать качество кода.
*   **Отрицательные/Затраты:**
    *   Команда должна следовать принятым конвенциям при создании новых интеграционных тестов.
# ADR-0017: Спецификация JWT и Обоснование Выбора

*   **Статус:** Утвержден
*   **Дата:** 2025-05-10
*   **Контекст:**
    *   Проекту "Task Tracker" требуется безопасный, stateless-механизм для представления аутентифицированного пользователя и передачи информации, необходимой для авторизации между клиентом и сервером, а также потенциально между сервисами в будущем.

*   **Принятое Решение: Использовать JSON Web Tokens (JWT)**

    1.  **Обоснование выбора JWT:**
        *   **Stateless:** Серверу не нужно хранить состояние сессии пользователя, что упрощает масштабирование и подходит для распределенных систем.
        *   **Self-contained:** Токен содержит всю необходимую информацию (claims) для идентификации пользователя и базовой авторизации, уменьшая необходимость частых обращений к БД или серверу аутентификации для валидации.
        *   **Стандарт (RFC 7519):** Широко распространенный и поддерживаемый стандарт с множеством библиотек.
        *   **Гибкость:** Подходит для различных типов клиентов (веб, мобильные).
        *   **Безопасность (при правильном использовании):** Подписанные токены защищены от подделки. Использование HTTPS для передачи токенов защищает от их перехвата.

    2.  **Тип используемого токена:**
        *   Будет использоваться только **Access Token**.
        *   **Refresh Token:** На данном этапе **не используется** для упрощения архитектуры. Пользователю потребуется пройти повторную аутентификацию (логин) после истечения срока действия Access Token.

    3.  **Спецификация Access Token:**
        *   **3.1. Алгоритм Подписи:**
            *   **Текущая реализация:** Симметричный алгоритм **HS256 (HMAC with SHA-256)**. Секретный ключ для подписи будет генерироваться и управляться через переменные окружения.
            *   **Перспектива:** Архитектура должна предусматривать возможность конфигурации для поддержки асимметричных алгоритмов (например, RS256) при будущей интеграции с внешними Identity Provider (IdP).
        *   **3.2. Состав (Claims):**
            *   `iss` (Issuer): Идентификатор сервиса, выдавшего токен (например, URI или имя сервиса `task-tracker-backend`).
            *   `sub` (Subject): **Уникальный числовой идентификатор пользователя (`Long id`)** из базы данных. Является основным идентификатором пользователя в контексте токена.
            *   `exp` (Expiration Time): Unix timestamp, определяющий время истечения срока действия токена.
            *   `iat` (Issued At): Unix timestamp, определяющий время выдачи токена.
            *   `jti` (JWT ID): Уникальный идентификатор токена (рекомендуется для обеспечения уникальности и возможности отслеживания).
            *   `email` (Кастомный claim): Email адрес пользователя, связанного с `sub`. Предназначен для удобства использования на клиенте или в других сервисах.
            *   `authorities` (Кастомный claim): *Массив строк. Зарезервировано для будущего использования* (например, для передачи ролей пользователя, таких как `"ROLE_ADMIN"`).
        *   **3.3. Время Жизни:**
            *   **15-60 минут.** Конкретное значение настраивается через конфигурацию приложения. Короткое время жизни повышает безопасность, уменьшая окно для использования потенциально скомпрометированного токена.
        *   **3.4. Передача Клиентом:**
            *   Токен должен передаваться клиентом в HTTP-заголовке `Authorization` со схемой `Bearer`:
                `Authorization: Bearer <token>`
        *   **3.5. Отзыв Токенов (Revocation):**
            *   На данном этапе **не реализуется**, так как JWT по своей природе stateless. Операция Logout на стороне клиента будет заключаться в удалении токена из хранилища клиента.

*   **Рассмотренные Альтернативы (механизму представления сессии):**
    *   **Сессионные cookie (Stateful):** Требуют хранения состояния сессии на сервере, что усложняет масштабирование и не всегда удобно для API-ориентированных и микросервисных архитектур.
    *   **Непрозрачные токены (Reference Tokens):** Токен является лишь ссылкой на данные сессии, хранящиеся на сервере. Требуют обращения к серверу аутентификации для валидации при каждом запросе, что увеличивает нагрузку, но упрощает отзыв токенов.

*   **Последствия и Рекомендации:**
    *   Необходимость обеспечения безопасного управления и ротации секретного ключа, используемого для подписи токенов (алгоритм HS256).
    *   Клиентские приложения должны корректно обрабатывать истечение срока действия Access Token и реализовывать логику повторной аутентификации пользователя.
    *   Размер JWT должен оставаться разумным. Не следует перегружать токен избыточным количеством claims; информация, не требующаяся для каждого запроса, должна запрашиваться через API.
    *   Всегда использовать HTTPS для передачи JWT для предотвращения их перехвата.

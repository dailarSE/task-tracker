**ADR-0023: Стандарт Применения Логгирования**

*   **Статус:** Утверждено
*   **Дата:** 2025-05-12
*   **Связанные ADR:**
    *   ADR-0009: Определение стратегии обсервабилити и выбор технологического стека (определяет фреймворк SLF4J/Logback, формат JSON ECS и автоматический инжект `trace_id`/`span_id`).
    *   ADR-0028: Требования к Применению Трассировки (Трейсы и Спаны) (дополняет информацией о корреляции).
*   **Контекст:**
    *   ADR-0009 определяет техническую основу для логгирования (инструменты, формат). Этот ADR устанавливает соглашения о том, **что, когда и как логгировать** внутри кода приложения `task-tracker-backend` для обеспечения эффективной диагностики, аудита безопасности и мониторинга бизнес-процессов.
    *   Цель – сделать логи информативными, безопасными и полезными для всех этапов жизненного цикла приложения.

*   **Принятые Решения:**

    1.  **Уровни Логгирования и Смысловое Назначение:**
        *   **`ERROR`:**
            *   **Назначение:** Критические ошибки, которые привели к сбою операции, невозможности обработать запрос, потенциальной потере данных или нарушению консистентности системы. Требуют немедленного внимания и расследования.
            *   **Примеры:** Непредвиденные исключения в ключевой бизнес-логике, ошибки при взаимодействии с критическими внешними системами (БД, Kafka – если это приводит к сбою), серьезные проблемы конфигурации при старте (например, невалидный JWT-ключ, как в `JwtTokenProvider`).
            *   **Действие:** Всегда логгировать полное исключение (стектрейс).
        *   **`WARN`:**
            *   **Назначение:** Потенциальные проблемы, ожидаемые, но нежелательные события, или ситуации, которые не прервали операцию, но могут привести к проблемам в будущем или указывают на некорректное использование API/системы.
            *   **Примеры:** Неудачная попытка аутентификации (неверный пароль), попытка регистрации с уже существующим email, использование устаревшего API (если применимо), некритичные ошибки конфигурации (например, JWT-ключ короче рекомендуемого, но система продолжает работу), превышение каких-либо ожидаемых лимитов (если это не ошибка). Неуспешная валидация входных данных от клиента (если это не результат злонамеренных действий, а просто ошибка пользователя).
            *   **Действие:** Логгировать достаточный контекст для понимания причины. Исключение (если есть) может быть залоггировано, если оно несет полезную информацию.
        *   **`INFO`:**
            *   **Назначение:** Значимые бизнес-события и этапы жизненного цикла приложения/компонентов. Позволяют отслеживать нормальное течение процессов.
            *   **Примеры:** Успешная аутентификация пользователя, успешная регистрация пользователя, создание/изменение/удаление ключевых бизнес-сущностей (например, задачи), старт и успешная инициализация ключевых сервисов, выполнение запланированных задач (Scheduler).
            *   **Действие:** Логгировать идентификаторы затронутых сущностей и ключевые параметры операции.
        *   **`DEBUG`:**
            *   **Назначение:** Детальная информация о ходе выполнения внутренних операций, полезная для разработчиков при отладке и трассировке конкретного запроса или процесса.
            *   **Примеры:** Вход/выход из важных методов, значения ключевых переменных внутри методов, детали шагов при обработке запроса, информация о процессе генерации/валидации JWT (без самого токена), детали взаимодействия с внешними системами (например, параметры запроса к БД, если это не логируется Hibernate).
            *   **Действие:** Не должен содержать избыточной информации, не "зашумлять" логи без необходимости.
        *   **`TRACE`:**
            *   **Назначение:** Очень низкоуровневая, максимально детализированная информация. Используется редко, для глубокой отладки сложных или проблемных участков кода.
            *   **Примеры:** Дамп состояния объектов, пошаговое выполнение циклов или сложных алгоритмов.
            *   **Действие:** Использовать с осторожностью, так как может генерировать очень большой объем логов.

    2.  **Содержание Лог-сообщений:**
        *   **Информативность:** Сообщения должны быть понятными и содержать достаточно контекста, чтобы можно было однозначно идентифицировать событие и, при необходимости, воспроизвести ситуацию или найти связанные данные.
        *   **Идентификаторы:** Включать релевантные идентификаторы (например, `userId`, `taskId`, `email`, `jti` токена) для упрощения поиска и корреляции логов. Уровни DEBUG/TRACE могут содержать больше таких идентификаторов, чем INFO/WARN.
        *   **Безопасность (Недопустимое Содержимое):**
            *   **НИКОГДА** не логгировать пароли в открытом виде или их хеши (кроме как на уровне TRACE в специальном режиме отладки, если это абсолютно необходимо и контролируемо).
            *   **НИКОГДА** не логгировать полные JWT Access Tokens. Допускается логгирование JTI, `sub`, `iss`, `exp` или усеченной/замаскированной части токена на уровне DEBUG для диагностики.
            *   **НИКОГДА** не логгировать полные секретные ключи или другую высокочувствительную конфигурационную информацию.
            *   **Ограничивать логгирование Персональных Идентификационных Данных (PII):** Email и `userId` могут логгироваться на уровне DEBUG или INFO для отслеживания действий пользователя, но следует избегать логгирования другой PII без крайней необходимости и соответствующего уровня защиты логов.
        *   **Параметризация:** Использовать параметризованные лог-сообщения (`log.info("User {} processed task {}", userId, taskId);`) вместо конкатенации строк для лучшей производительности и читаемости.

    3.  **Контекстная Информация и Корреляция:**
        *   **MDC (Mapped Diagnostic Context):** После успешной аутентификации пользователя, его `userId` (и, возможно, `email` или другой стабильный идентификатор) **ДОЛЖЕН** быть помещен в MDC. Это позволит автоматически добавлять `userId` ко всем лог-сообщениям, сгенерированным в рамках обработки запроса этого пользователя. Необходимо обеспечить очистку MDC после завершения обработки запроса.
            *   Пример реализации: в `JwtAuthenticationFilter` после успешной установки `Authentication`.
        *   **`trace_id` / `span_id`:** Эти идентификаторы автоматически добавляются в логи благодаря интеграции с OpenTelemetry (ADR-0009) и служат для корреляции логов с распределенными трассами. На уровне кода приложения для этого специальных действий не требуется, кроме как не мешать работе OTel агента/инструментации.

    4.  **Логгирование Исключений:**
        *   При перехвате исключения, если оно не обрабатывается полностью и не "проглатывается" намеренно, оно **ДОЛЖНО** быть залоггировано, как правило, на уровне `ERROR` или `WARN` (в зависимости от серьезности).
        *   Логгирование исключения **ДОЛЖНО** включать полный стектрейс для облегчения диагностики.
            *   Пример: `log.error("Failed to process user registration for email: {}", request.getEmail(), e);`

    5.  **Аудит Безопасности:**
        *   Ключевые события, связанные с безопасностью, **ДОЛЖНЫ** логгироваться как минимум на уровне `INFO` или `WARN`:
            *   Успешный логин (`INFO`).
            *   Неудачная попытка логина (`WARN`).
            *   Создание пользователя (`INFO`).
            *   Значимые изменения в профиле пользователя или его правах (если/когда появятся) (`INFO`).
            *   Срабатывание правил авторизации, приводящее к отказу в доступе (`WARN` или `INFO`, в зависимости от ожидаемости).
            *   Ошибки валидации JWT (`DEBUG` для `ExpiredJwtException`, `WARN` для других `JwtException`).

*   **Рассмотренные Альтернативы:**
    *   Отсутствие стандартов логгирования: Приводит к хаотичным, неинформативным или небезопасным логам.
    *   Слишком избыточное или слишком скудное логгирование: Затрудняет диагностику или перегружает систему логов.
*   **Последствия:**
    *   Улучшение наблюдаемости приложения.
    *   Облегчение диагностики проблем и анализа инцидентов безопасности.
    *   Обеспечение консистентного и безопасного подхода к логгированию во всем приложении.
    *   Требует от разработчиков осознанного подхода к написанию лог-сообщений и выбору уровней.

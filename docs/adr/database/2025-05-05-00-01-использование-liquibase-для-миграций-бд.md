# ADR-0004: Использование Liquibase для управления миграциями базы данных

**Статус:** Accepted

**Дата:** 2025-05-05

## Контекст

Проект "Task Tracker" требует использования реляционной базы данных (PostgreSQL) для хранения данных о пользователях и задачах. Схема базы данных будет эволюционировать по мере развития проекта: будут добавляться новые таблицы, изменяться существующие, создаваться индексы и т.д. Необходимо обеспечить контролируемый, версионируемый и автоматизированный способ применения этих изменений схемы к базам данных в различных окружениях (локальная разработка, CI, будущие стейджинг/продакшен).

## Принятое Решение

Использовать **Liquibase** в качестве инструмента для управления миграциями схемы базы данных. Миграции будут писаться в формате YAML и интегрироваться с жизненным циклом Spring Boot приложения, так что они будут автоматически применяться при старте приложения.

## Рассмотренные Альтернативы

1.  **Hibernate `ddl-auto` (например, `create`, `update`):**
    *   **Описание:** Позволить Hibernate автоматически генерировать и применять изменения схемы на основе JPA-сущностей.
    *   **Плюсы:** Простота для быстрой разработки и прототипирования. Не требует написания отдельных миграционных скриптов.
    *   **Минусы:**
        *   Не подходит для продакшен-окружений из-за риска потери данных (особенно `create` или `create-drop`).
        *   Режим `update` может быть непредсказуемым и не всегда корректно обрабатывать сложные изменения схемы (переименования колонок, разделение таблиц и т.д.).
        *   Отсутствует версионирование изменений схемы и явный контроль над применяемыми SQL-скриптами.
        *   Сложно или невозможно выполнить сложные миграции данных, требующие специфичного SQL.
    *   **Причина отклонения:** Недостаточная надежность и контролируемость для управления схемой БД за пределами очень раннего прототипирования. Мы используем `ddl-auto: validate` для проверки соответствия сущностей схеме, созданной Liquibase.

2.  **Flyway:**
    *   **Описание:** Другой популярный инструмент для управления миграциями БД на основе SQL-скриптов.
    *   **Плюсы:** Очень популярен, прост в освоении, особенно если команда хорошо знакома с SQL. Надежен. Хорошая интеграция со Spring Boot.
    *   **Минусы (по сравнению с Liquibase для наших целей):**
        *   Управление изменениями (changeset'ы) в Liquibase позволяет лучше отслеживать и выборочно применять/откатывать атомарные изменения. Откат в Flyway более сложен (требует написания undo-миграций).
    *   **Причина отклонения:** Хотя Flyway является отличным инструментом, гибкость Liquibase в плане форматов (мы выбрали YAML) и более гранулярное управление changeset'ами показались предпочтительнее для нашего проекта.

3.  **Ручное написание и применение SQL-скриптов:**
    *   **Описание:** Разработчики пишут SQL-скрипты для изменения схемы, а администраторы баз данных (или разработчики) применяют их вручную.
    *   **Плюсы:** Полный контроль над SQL.
    *   **Минусы:** Высокий риск человеческой ошибки, отсутствие автоматизации, сложность версионирования и отслеживания примененных изменений, не подходит для CI/CD.
    *   **Причина отклонения:** Полностью противоречит принципам автоматизации и DevOps.

## Последствия

*   **Положительные:**
    *   Версионируемая и воспроизводимая схема БД.
    *   Автоматическое применение миграций при старте приложения.
    *   Возможность писать миграции в декларативном формате (YAML), что может улучшить читаемость и независимость от СУБД для стандартных операций.
    *   Интеграция со Spring Boot упрощает настройку.
    *   Поддержка отката изменений (если откат описан или может быть сгенерирован Liquibase).
*   **Отрицательные/Затраты:**
    *   Необходимо изучить синтаксис и концепции Liquibase (changeset'ы, contexts, labels и т.д.).
    *   Миграционные файлы становятся частью кодовой базы и требуют поддержки.
    *   Небольшое увеличение времени старта приложения из-за проверки и применения миграций.
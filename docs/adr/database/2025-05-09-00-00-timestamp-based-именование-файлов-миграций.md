# ADR-0006: Использование Timestamp-based именования для файлов миграций Liquibase

**Статус:** Accepted

**Дата:** 2025-05-09

## Контекст

При использовании Liquibase (согласно ADR-0004) для управления миграциями схемы базы данных, необходимо определить консистентную и надежную стратегию именования файлов, содержащих changeset'ы. Порядок применения миграций критически важен, и имена файлов часто используются для определения этого порядка, особенно при ручном просмотре или если Liquibase настроен на чтение всех файлов из директории (`includeAll`).

Первоначальный подход с простой последовательной нумерацией (например, `001-description.yaml`, `002-description.yaml`) имеет недостаток: при достижении номеров с разным количеством знаков (например, `099-` и `100-`) лексикографическая сортировка файлов может нарушить предполагаемый хронологический порядок.

## Принятое Решение

Использовать **именование файлов миграций Liquibase на основе временной метки (timestamp-based naming)**.
Формат имени файла будет следующим: `YYYY-MM-DD-HH-MM-SS-краткое-описательное-имя.yaml`.
Например: `2025-05-09-10-30-00-create-users-table.yaml`.

Временная метка соответствует моменту создания (или коммита) файла миграции.

## Рассмотренные Альтернативы

1.  **Простая последовательная нумерация (например, `1-desc.yaml`, `2-desc.yaml`, ...):**
    *   **Описание:** Использование простого возрастающего числового префикса.
    *   **Плюсы:** Очень просто для понимания.
    *   **Минусы:** Проблемы с лексикографической сортировкой при разном количестве цифр в префиксе (например, `10-` будет идти перед `2-` при сортировке по имени). Может привести к ошибкам в порядке применения, если порядок определяется по именам файлов.
    *   **Причина отклонения:** Ненадежно для обеспечения правильного порядка в долгосрочной перспективе.

2.  **Нумерация с ведущими нулями (Padding with Zeros, например, `0001-desc.yaml`, `0002-desc.yaml`, ...):**
    *   **Описание:** Использование числового префикса с фиксированным количеством цифр, дополненного ведущими нулями.
    *   **Плюсы:** Решает проблему лексикографической сортировки для заданного диапазона номеров. Относительно просто.
    *   **Минусы:** Необходимо заранее выбрать максимальное количество цифр. Если количество миграций превысит этот лимит (например, `9999` для 4 цифр), проблема сортировки может возникнуть снова при переходе на большее количество цифр.
    *   **Причина отклонения:** Хотя это лучше простой нумерации, timestamp-based подход более гибок и не имеет ограничений по количеству миграций.

3.  **Использование только описательных имен (например, `create-users-table.yaml`):**
    *   **Описание:** Имена файлов отражают только суть изменения.
    *   **Плюсы:** Легко понять назначение файла по его имени.
    *   **Минусы:** Порядок применения полностью зависит от явного указания в мастер-файле `db.changelog-master.yaml` и никак не отражен в именах файлов. Высокий риск ошибки при ручном добавлении `include` в неправильном порядке. Не подходит для `includeAll`.
    *   **Причина отклонения:** Не обеспечивает явного порядка через именование.

## Последствия

*   **Положительные:**
    *   Гарантирует уникальность имен файлов миграций (при условии, что миграции не создаются в одну и ту же секунду).
    *   Обеспечивает естественный хронологический и лексикографический порядок файлов, что соответствует порядку их применения.
    *   Не зависит от общего количества миграций.
    *   Является распространенной практикой во многих фреймворках миграций.
*   **Отрицательные/Затраты:**
    *   Имена файлов становятся длиннее.
    *   Сложнее быстро найти миграцию по "порядковому номеру", если он не является частью описания (но дата создания дает хороший контекст).
*   **Необходимые действия:**
    *   Переименовать существующие файлы миграций в соответствии с новым форматом.
    *   Обновить ссылки на файлы миграций в `db.changelog-master.yaml`.
    *   Придерживаться этого формата для всех будущих миграций.

## Связанные ADR

*   ADR-0004: Использование Liquibase для управления миграциями базы данных
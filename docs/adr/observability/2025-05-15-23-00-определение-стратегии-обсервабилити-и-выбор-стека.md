**ADR-0028: Обновленная Стратегия Обсервабилити и Выбор Технологического Стека**

*   **Статус:** Утвержден
*   **Дата:** 2025-05-15
*   **Заменяет:** [ADR-0009: Определение стратегии обсервабилити и выбор технологического стека](./../observability/2025-05-07-00-00-определение-стратегии-обсервабилити-и-выбор-стека.md) (ADR-0009 теперь имеет статус "Superseded by ADR-0028")
*   **Связанные ADR:**
    *   [ADR-0023: Стандарт Применения Логгирования в Приложении](./../common/2025-05-12-10-05-стандарт-применения-логгирования.md)
    *   [ADR-0026: Требования к Применению Распределенной Трассировки](./../common/2025-05-12-10-25-стандарт-распределенной-трассировки.md)
*   **Контекст:**
    *   Проект "Task Tracker" требует надежных механизмов для мониторинга, отладки и анализа производительности. ADR-0009 заложил основу для стека обсервабилити.
    *   В ходе дальнейшей проработки (в частности, ADR-0026) и анализа интеграции `opentelemetry-spring-boot-starter` возникла необходимость уточнить стратегию инструментации трассировки и роль Micrometer в экосистеме обсервабилити проекта.
    *   Данный ADR обновляет и заменяет ADR-0009, предоставляя актуализированную информацию по стратегии и технологическому стеку.

*   **Принятое Решение (Обновленная Стратегия):**

    1.  **Стандарт и Протокол для Телеметрии:**
        *   **OpenTelemetry (OTel)** остается основным стандартом для генерации, сбора и экспорта всех трех сигналов обсервабилити: логов, метрик и распределенных трейсов.
        *   Протокол **OTLP (OpenTelemetry Protocol)** используется для передачи телеметрических данных.

    2.  **Централизованный Сбор Телеметрии:**
        *   **OTel Collector** используется как центральный компонент для приема OTLP данных от приложений, их возможной обработки (например, батчинг) и экспорта в соответствующие бэкенды.

    3.  **Бэкенды для Хранения и Анализа Сигналов:**
        *   **Метрики:** **Prometheus** для сбора, хранения и запроса метрик.
        *   **Трейсы:** **Tempo** для сбора, хранения и запроса распределенных трейсов.
        *   **Логи:** **Loki** для сбора, хранения и запроса логов.
        *   **Визуализация:** **Grafana** как единый интерфейс для визуализации метрик (из Prometheus), трейсов (из Tempo) и логов (из Loki).
        *   **SPAN-метрики и Графы Сервисов из Трейсов:** **Tempo** (с компонентом `metrics_generator`) анализирует входящие трейсы для генерации агрегированных метрик (RED-метрики: Rate, Errors, Duration) и данных для графа зависимостей сервисов. Эти метрики экспортируются из Tempo в **Prometheus** через `remote_write`.

    4.  **Инструментация Бэкенд-Приложений (Java/Spring Boot - `task-tracker-backend` и аналогичные):**
        *   **Основной Интеграционный Компонент:** Зависимость `io.opentelemetry.instrumentation:opentelemetry-spring-boot-starter` является ключевой для интеграции Spring Boot приложений с OpenTelemetry.
        *   **Логирование:**
            *   **Фреймворк:** SLF4J с реализацией Logback.
            *   **Формат:** Структурированные логи в формате **JSON ECS (Elastic Common Schema)** для вывода в консоль и для экспорта.
            *   **Экспорт:** Логи захватываются и экспортируются в OTel Collector (и далее в Loki) через **OTel Logback Appender**, сконфигурированный в `logback-spring.xml` (или через автоконфигурацию, если `otel.instrumentation.logback-appender.enabled=true`).
            *   **Корреляция:** `trace_id` и `span_id` (из OpenTelemetry) автоматически включаются в экспортируемые логи, обеспечивая их связь с трассами (согласно ADR-0023).
        *   **Метрики:**
            *   **API и Сбор:** Используется **Micrometer API** (стандартный для Spring Boot). Собираются стандартные метрики Spring Boot Actuator, JVM, пула соединений DataSource и другие автоконфигурируемые Micrometer-метрики.
            *   **Кастомные Метрики:** Разработчики **ДОЛЖНЫ** создавать кастомные бизнес- и технические метрики с использованием Micrometer API.
            *   **Экспорт:** Метрики, собранные Micrometer, экспортируются в OTel Collector через мост `micrometer-registry-otlp` (требует `otel.instrumentation.micrometer.enabled=true` в конфигурации).
        *   **Трассировка:**
            *   **API и Авто-Инструментация:** Используется **OpenTelemetry SDK**, интегрированный через `opentelemetry-spring-boot-starter`. Этот стартер обеспечивает авто-инструментацию для стандартных компонентов (Spring WebMVC, JDBC, Kafka и т.д.).
            *   **Кастомная Инструментация:** Для добавления специфичных для приложения спанов и атрибутов **ДОЛЖЕН** использоваться **OpenTelemetry API** напрямую или через декларативные аннотации из пакета `io.opentelemetry.instrumentation.annotations` (например, `@WithSpan`, `@SpanAttribute`). Это требует добавления зависимости `spring-boot-starter-aop`. Детали и критерии применения кастомной инструментации описаны в **ADR-0026**.
            *   **Распространение Контекста:** Контекст трассировки распространяется автоматически для поддерживаемых протоколов. Особое внимание уделяется корректному распространению контекста при асинхронных операциях (см. ADR-0026).

    5.  **Инфраструктура для Локальной Разработки (`dev`):**
        *   Полный стек обсервабилити (OTel Collector, Prometheus, Tempo, Grafana, Loki) разворачивается через `docker-compose.yml`.

    6.  **Конфигурация Обсервабилити по Профилям Spring Boot:**
        *   **`dev`:** Максимальная детализация. Все экспортеры OTel включены, 100% сэмплирование трейсов, подробные логи. `otel.instrumentation.micrometer.enabled=true`.
        *   **`ci`:** Фокус на диагностике тестов. **OTel SDK и экспорт OTLP для трейсов и метрик ОТКЛЮЧЕНЫ** (`otel.sdk.disabled=true`) для экономии ресурсов и ускорения CI-сборок. Логирование подробное (DEBUG для приложения и SQL), формат JSON ECS, но без автоматической корреляции `trace_id`/`span_id` из-за отключенного OTel SDK.
        *   **`prod` (видение):** Фокус на мониторинге здоровья, SLI/SLO, алертинге. Сэмплирование трейсов (например, вероятностное или хвостовое), уровни логирования INFO/WARN, экспорт всех сигналов в выделенный, отказоустойчивый стек. `otel.instrumentation.micrometer.enabled=true`.

*   **Рассмотренные Альтернативы (не изменились существенно с ADR-0009, но повторены для полноты):**
    *   Использование отдельных, неинтегрированных инструментов для каждого сигнала (ELK, Prometheus отдельно, Jaeger/Zipkin отдельно): Отвергнуто в пользу единого подхода OTel.
    *   Только логирование и базовые метрики Actuator без OTel: Недостаточно для микросервисной архитектуры.
    *   Полностью коммерческие решения: Выходят за рамки бюджета и целей проекта.
    *   Исключительное использование Micrometer Tracing API как фасада для трассировки: Отвергнуто в пользу прямого использования OTel API и аннотаций для трассировки, как более соответствующее экосистеме OpenTelemetry и обеспечивающее прямой контроль, в то время как Micrometer остается основным инструментом для метрик.

*   **Последствия:**
    *   **Улучшение ясности стратегии:** Четко определена роль OTel API для трассировки и Micrometer API для метрик, что устраняет возможную путаницу из предыдущей версии ADR.
    *   Остальные положительные и отрицательные последствия, а также необходимые действия, в целом аналогичны указанным в ADR-0009, но с акцентом на обновленную стратегию инструментации.
    *   Требуется наличие зависимости `spring-boot-starter-aop` для работы OTel-аннотаций `@WithSpan` и `@SpanAttribute`.
    *   Команда будет использовать `io.opentelemetry.instrumentation.annotations` для декларативной трассировки.
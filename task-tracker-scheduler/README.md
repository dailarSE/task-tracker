# Task Tracker Scheduler Service

Этот сервис является компонентом системы "Task Tracker" и отвечает за выполнение периодических, фоновых задач, связанных с анализом данных и инициированием уведомлений для пользователей.

## Основные Обязанности

*   **Запуск по расписанию:** Активируется один раз в сутки (в полночь) для выполнения своей основной задачи.
*   **Сбор данных:** Обращается к `task-tracker-backend` API для получения данных о пользователях и их задачах.
*   **Анализ и формирование отчетов:** Анализирует полученные данные для формирования отчетов (например, о количестве выполненных и оставшихся задач).
*   **Публикация команд в Kafka:** Публикует сформированные отчеты в виде команд в топик Kafka для последующей обработки сервисом-рассыльщиком (`task-tracker-email-sender`).

## Архитектура

Архитектура сервиса спроектирована с учетом отказоустойчивости, производительности и будущей расширяемости, как описано в **ADR-0040: Архитектура Сервиса-Планировщика**.

Ключевые принципы:

1.  **Разделение ответственности:** Логика разделена на три слоя:
    *   `JobTrigger`: Запускает процесс по расписанию (`@Scheduled`).
    *   `TaskRunManager`: Управляет жизненным циклом одного запуска, обеспечивая уникальность выполнения и отслеживая прогресс. На текущем этапе используется `InMemoryTaskRunManager`.
    *   `JobExecutionService`: Выполняет основную бизнес-логику.
2.  **Producer/Consumer паттерн:** Для обработки большого количества пользователей используется внутренний паттерн "Производитель-Потребитель".
    *   **Producer:** Получает список ID всех пользователей от `task-tracker-backend` API.
    *   **Consumer(ы):** Работают в несколько потоков, забирают ID пользователей пачками и запрашивают для них отчеты у `task-tracker-backend` API, после чего публикуют результат в Kafka.
3.  **Взаимодействие с Backend API:**
    *   Взаимодействие происходит через внутренние, защищенные эндпоинты (`/api/v1/internal/**`).
    *   Аутентификация осуществляется с помощью статического API-ключа (согласно **ADR-0039**).

## Конфигурация

Основные параметры конфигурации управляются через `application.yml`.

```yaml
app:
  # Настройки для HTTP-клиента, подключающегося к backend
  client:
    backend:
      url: http://task-tracker-backend:8080 # Адрес внутри Docker-сети
      api-key: ${BACKEND_API_KEY} # Ключ должен быть предоставлен через переменную окружения

  # Настройки для Kafka-продюсера
  kafka:
    producer:
      # Имя топика, куда будут отправляться команды-отчеты
      topic-name: ${app.kafka.topic.email-commands.name} 
```

Для локальной разработки необходимо определить переменную окружения `BACKEND_API_KEY`.

## Локальный Запуск и Тестирование

### Запуск

1.  Убедитесь, что все зависимости (PostgreSQL, Kafka, `task-tracker-backend`) запущены через `docker-compose up -d` в корне проекта.
2.  Запустите главный класс `TaskTrackerSchedulerApplication.java` из вашей IDE.